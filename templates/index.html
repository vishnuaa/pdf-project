<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Image Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: auto;
            padding: 1em;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: auto;
            border: 1px solid #ccc;
        }

        .rectangle {
            position: absolute;
            background-color: blue;
            opacity: 0.5;
            cursor: move;
            box-sizing: border-box;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            bottom: 0;
            right: 0;
            cursor: se-resize;
        }

        .image-wrapper {
            position: relative;
            margin: 1em 0;
            padding: 1em;
            display: none;
            text-align: center;
        }

        .image-wrapper.active {
            display: block;
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2 {
            text-align: center;
        }

        form, button {
            margin: 0.5em;
        }

        .controls {
            margin-top: 0.5em;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            justify-content: center;
        }

        input[type="text"] {
            max-width: 200px;
            padding: 0.4em;
        }

        button {
            padding: 0.5em 1em;
            font-size: 1em;
        }

        /* Responsive for small devices */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            form, button {
                width: 100%;
                box-sizing: border-box;
            }

            input[type="text"] {
                width: 100%;
            }

            button {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <h1>Upload PDFs</h1>
    <form action="/upload" method="POST" enctype="multipart/form-data" style="text-align: center;">
        <input type="file" name="files" accept=".pdf" multiple>
        <button type="submit">Upload</button>
    </form>

    <form action="{{ url_for('download_pdfs') }}" method="get" style="text-align: center;">
        <button type="submit">Download Final PDFs</button>
    </form>

    {% for folder, images in pdf_images.items() %}
        {% set pdf_index = loop.index %}
        <h2>PDF: {{ folder }}</h2>
        <form action="{{ url_for('rename_folder', old_name=folder) }}" method="POST" style="margin-bottom: 10px; text-align: center;">
             <input type="text" name="new_name" placeholder="Rename PDF">
             <button type="submit">Rename</button>
        </form>

        <div id="pdf-{{ pdf_index }}">
            <div class="image-container">
                {% for image in images %}
                    {% set img_index = loop.index %}
                    <div class="image-wrapper {% if loop.first %}active{% endif %}" data-pdf="{{ pdf_index }}">
                        <img id="image-{{ pdf_index }}-{{ img_index }}" src="{{ image }}" alt="PDF Image">

                        <div class="controls">
                            <button type="button" onclick="drawRectangle({{ pdf_index }}, {{ img_index }})">Draw Rectangle</button>

                            <form action="{{ url_for('rotate_image', folder=folder, image_name=image.split('/')[-1]) }}" method="POST" style="display:inline;">
                                <button type="submit">Rotate 90Â°</button>
                            </form>

                            <form action="{{ url_for('delete_image', folder=folder, image_name=image.split('/')[-1]) }}" method="POST" style="display:inline;">
                                <button type="submit">Delete</button>
                            </form>

                            <form id="saveForm-{{ pdf_index }}-{{ img_index }}"
                                  action="{{ url_for('save_rectangle', folder=folder, image_name=image.split('/')[-1]) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="rect_x" id="rect_x-{{ pdf_index }}-{{ img_index }}">
                                <input type="hidden" name="rect_y" id="rect_y-{{ pdf_index }}-{{ img_index }}">
                                <input type="hidden" name="rect_width" id="rect_width-{{ pdf_index }}-{{ img_index }}">
                                <input type="hidden" name="rect_height" id="rect_height-{{ pdf_index }}-{{ img_index }}">
                                <button type="button" onclick="saveRectangle({{ pdf_index }}, {{ img_index }})">Save Rectangle</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div style="text-align: center;">
                <button onclick="prevImage({{ pdf_index }})">Back</button>
                <button onclick="nextImage({{ pdf_index }})">Next</button>
            </div>
        </div>
    {% endfor %}

    <script>
        const rectangles = {};
        const currentIndices = {};

        function showImage(pdfIndex, index) {
            const wrappers = document.querySelectorAll(`.image-wrapper[data-pdf="${pdfIndex}"]`);
            wrappers.forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
            currentIndices[pdfIndex] = index;
        }

        function nextImage(pdfIndex) {
            const wrappers = document.querySelectorAll(`.image-wrapper[data-pdf="${pdfIndex}"]`);
            const currentIndex = currentIndices[pdfIndex] || 0;
            if (currentIndex < wrappers.length - 1) {
                showImage(pdfIndex, currentIndex + 1);
            }
        }

        function prevImage(pdfIndex) {
            const currentIndex = currentIndices[pdfIndex] || 0;
            if (currentIndex > 0) {
                showImage(pdfIndex, currentIndex - 1);
            }
        }

        function drawRectangle(pdfIndex, imageIndex) {
            const wrapper = document.querySelectorAll(`.image-wrapper[data-pdf="${pdfIndex}"]`)[imageIndex - 1];
            const img = document.getElementById(`image-${pdfIndex}-${imageIndex}`);

            const rect = document.createElement('div');
            rect.className = 'rectangle';
            rect.style.width = '146px';
            rect.style.height = '29px';

            const centerX = (img.offsetWidth - 101) / 2;
            const centerY = (img.offsetHeight - 20) / 2;

            rect.style.left = centerX + 'px';
            rect.style.top = centerY + 'px';

            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            rect.appendChild(handle);
            wrapper.appendChild(rect);

            let isDragging = false;
            let offsetX, offsetY;

            function onMouseDown(e) {
                if (e.target === handle) return;
                isDragging = true;
                offsetX = e.clientX - rect.getBoundingClientRect().left;
                offsetY = e.clientY - rect.getBoundingClientRect().top;
                e.preventDefault();
            }

            function onTouchStart(e) {
                if (e.target === handle) return;
                const touch = e.touches[0];
                isDragging = true;
                offsetX = touch.clientX - rect.getBoundingClientRect().left;
                offsetY = touch.clientY - rect.getBoundingClientRect().top;
                e.preventDefault();
            }

            function onMove(e) {
                if (!isDragging) return;
                const clientX = e.clientX || e.touches?.[0].clientX;
                const clientY = e.clientY || e.touches?.[0].clientY;
                const imgRect = img.getBoundingClientRect();
                let left = clientX - imgRect.left - offsetX;
                let top = clientY - imgRect.top - offsetY;

                left = Math.max(0, Math.min(left, img.offsetWidth - rect.offsetWidth));
                top = Math.max(0, Math.min(top, img.offsetHeight - rect.offsetHeight));

                rect.style.left = left + 'px';
                rect.style.top = top + 'px';
            }

            function stopMove() {
                isDragging = false;
            }

            rect.addEventListener('mousedown', onMouseDown);
            rect.addEventListener('touchstart', onTouchStart, { passive: false });
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', stopMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', stopMove);

            // Resize handle
            handle.addEventListener('mousedown', function (e) {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = rect.offsetWidth;
                const startHeight = rect.offsetHeight;

                function doResize(ev) {
                    let newWidth = startWidth + (ev.clientX - startX);
                    let newHeight = startHeight + (ev.clientY - startY);
                    newWidth = Math.max(10, Math.min(newWidth, img.offsetWidth - rect.offsetLeft));
                    newHeight = Math.max(10, Math.min(newHeight, img.offsetHeight - rect.offsetTop));
                    rect.style.width = newWidth + 'px';
                    rect.style.height = newHeight + 'px';
                }

                function stopResize() {
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResize);
                }

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            });

            handle.addEventListener('touchstart', function (e) {
                e.stopPropagation();
                const touch = e.touches[0];
                const startX = touch.clientX;
                const startY = touch.clientY;
                const startWidth = rect.offsetWidth;
                const startHeight = rect.offsetHeight;

                function doResize(ev) {
                    const touchMove = ev.touches[0];
                    let newWidth = startWidth + (touchMove.clientX - startX);
                    let newHeight = startHeight + (touchMove.clientY - startY);
                    newWidth = Math.max(10, Math.min(newWidth, img.offsetWidth - rect.offsetLeft));
                    newHeight = Math.max(10, Math.min(newHeight, img.offsetHeight - rect.offsetTop));
                    rect.style.width = newWidth + 'px';
                    rect.style.height = newHeight + 'px';
                }

                function stopResize() {
                    document.removeEventListener('touchmove', doResize);
                    document.removeEventListener('touchend', stopResize);
                }

                document.addEventListener('touchmove', doResize, { passive: false });
                document.addEventListener('touchend', stopResize);
            }, { passive: false });

            rectangles[`${pdfIndex}-${imageIndex}`] = rect;
        }

        function saveRectangle(pdfIndex, imageIndex) {
            const rect = rectangles[`${pdfIndex}-${imageIndex}`];
            if (!rect) return;

            const img = document.getElementById(`image-${pdfIndex}-${imageIndex}`);
            const imgRect = img.getBoundingClientRect();
            const rectRect = rect.getBoundingClientRect();

            const scaleX = img.naturalWidth / img.width;
            const scaleY = img.naturalHeight / img.height;

            const x = (rectRect.left - imgRect.left) * scaleX;
            const y = (rectRect.top - imgRect.top) * scaleY;
            const width = rectRect.width * scaleX;
            const height = rectRect.height * scaleY;

            document.getElementById(`rect_x-${pdfIndex}-${imageIndex}`).value = x;
            document.getElementById(`rect_y-${pdfIndex}-${imageIndex}`).value = y;
            document.getElementById(`rect_width-${pdfIndex}-${imageIndex}`).value = width;
            document.getElementById(`rect_height-${pdfIndex}-${imageIndex}`).value = height;

            document.getElementById(`saveForm-${pdfIndex}-${imageIndex}`).submit();
        }
    </script>
</body>
</html>
